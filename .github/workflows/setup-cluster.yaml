name: Deploy to K8s Server

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy K8s manifests to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          source: "k8s/"
          target: "/tmp/my-app-deploy"
          overwrite: true

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
          DOCKER_USER: ${{ secrets.DOCKER_USER }}
          DOCKER_PASS: ${{ secrets.DOCKER_PASS }}
          DOCKER_EMAIL: ${{ secrets.DOCKER_EMAIL }}
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          envs: DOPPLER_TOKEN,DOCKER_USER,DOCKER_PASS,DOCKER_EMAIL
          script: |
            kubectl create namespace my-app --dry-run=client -o yaml | kubectl apply -f -

            kubectl create secret docker-registry dockerhub-secret \
              --docker-server=https://index.docker.io/v1/ \
              --docker-username=$DOCKER_USER \
              --docker-password=$DOCKER_PASS \
              --docker-email=$DOCKER_EMAIL \
              --namespace=my-app \
              --dry-run=client -o yaml | kubectl apply -f -

            export DOPPLER_TOKEN=$DOPPLER_TOKEN
            doppler secrets download --no-file --format docker > /tmp/my-app-deploy/.env
            kubectl create secret generic doppler-secrets \
              --from-env-file=/tmp/my-app-deploy/.env \
              -n my-app \
              --dry-run=client -o yaml | kubectl apply -f -
            rm /tmp/my-app-deploy/.env

            cd /tmp/my-app-deploy
            kubectl apply -f k8s/certificate.yaml
            kubectl apply -f k8s/db-deployment.yaml
            kubectl apply -f k8s/server-deployment.yaml
            kubectl apply -f k8s/client-deployment.yaml
            kubectl apply -f k8s/ingress-service.yaml

            cd ~
            rm -rf /tmp/my-app-deploy

            kubectl rollout restart deployment frontend -n my-app
            kubectl rollout restart deployment backend -n my-app
